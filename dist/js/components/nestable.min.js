/*!
 *  CliqueUI - v1.0.4 - 2015-10-14
 *  http://ui.cliquestudios.com
 *  Copyright (c) 2015 Clique Studios;
 */

!function(a){if("function"==typeof define&&define.amd&&define("clique-nestable",["clique"],function(){return a(Clique)}),!window.Clique)throw new Error("Clique.nestable requires Clique.core");window.Clique&&a(Clique)}(function(a){var b,c,d,e,f,g,h,i,j,k,l,m;return b=a.$,k=!1,l=a.$html,m=[],c=a.$win,e=void 0,d=void 0,j=function(){var a,b,c;return b=document.createElement("div"),a=document.documentElement,"pointerEvents"in b.style?(b.style.pointerEvents="auto",b.style.pointerEvents="x",a.appendChild(b),c=window.getComputedStyle&&"auto"===window.getComputedStyle(b,"").pointerEvents,a.removeChild(b),!!c):!1}(),i=k?"touchstart":"mousedown",h=k?"touchmove":"mousemove",g=k?"touchend":"mouseup",f=k?"touchcancel":"mouseup",a.component("nestable",{defaults:{prefix:"",listNodeName:"ul",itemNodeName:"li",listBaseClass:"{prefix}nestable",listClass:"{prefix}nestable-list",listitemClass:"{prefix}nestable-list-item",itemClass:"{prefix}nestable-item",dragClass:"{prefix}nestable-list-dragged",movingClass:"{prefix}nestable-moving",handleClass:"{prefix}nestable-handle",collapsedClass:"{prefix}collapsed",placeClass:"{prefix}nestable-placeholder",noDragClass:"{prefix}nestable-nodrag",emptyClass:"{prefix}nestable-empty",group:0,maxDepth:10,threshold:20},boot:function(){return a.$html.on("mousemove touchmove",function(b){var c;if(e){if(c=e.offset().top,c<a.$win.scrollTop())return a.$win.scrollTop(a.$win.scrollTop()-Math.ceil(e.height()/2));if(c+e.height()>window.innerHeight+a.$win.scrollTop())return a.$win.scrollTop(a.$win.scrollTop()+Math.ceil(e.height()/2))}}),a.ready(function(b){return a.$("[data-nestable]",b).each(function(){var b,c;b=a.$(this),b.data("clique.data.nestable")||(c=a.nestable(b,a.utils.options(b.attr("data-nestable"))))})})},init:function(){var b,d,j,l;return b=this,a.$doc.on("updated.browser.clique",function(){var b;b=a.$doc.data("clique.data.browser"),k=b.screen.touch}),Object.keys(this.options).forEach(function(a){-1!==String(b.options[a]).indexOf("{prefix}")&&(b.options[a]=b.options[a].replace("{prefix}",b.options.prefix))}),this.tplempty='<div class="'+this.options.emptyClass+'"/>',this.find(">"+this.options.itemNodeName).addClass(this.options.listitemClass).end().find("ul:not(.ignore-list)").addClass(this.options.listClass).find(">li").addClass(this.options.listitemClass),this.element.children(this.options.itemNodeName).length||this.element.append(this.tplempty),this.element.data("nestable-id","ID"+(new Date).getTime()+"RAND"+Math.ceil(1e5*Math.random())),this.reset(),this.element.data("nestable-group",this.options.group),this.placeEl=a.$('<div class="'+this.options.placeClass+'"/>'),this.find(this.options.itemNodeName).each(function(){return b.setParent(a.$(this))}),this.on("click","[data-nestable-action]",function(c){var d,e,f;b.dragEl||!k&&0!==c.button||(c.preventDefault(),f=a.$(c.currentTarget),d=f.data("nestableAction"),e=f.closest(b.options.itemNodeName),"collapse"===d&&b.collapseItem(e),"expand"===d&&b.expandItem(e),"toggle"===d&&b.toggleItem(e))}),l=function(c){var d;if(d=a.$(c.target),!d.hasClass(b.options.handleClass)){if(d.closest("."+b.options.noDragClass).length)return;d=d.closest("."+b.options.handleClass)}!d.length||b.dragEl||!k&&0!==c.button||k&&1!==c.touches.length||(c.preventDefault(),b.dragStart(k?c.touches[0]:c),b.trigger("start.uk.nestable",[b]))},j=function(a){return b.dragEl?(a.preventDefault(),b.dragMove(k?a.touches[0]:a),b.trigger("move.uk.nestable",[b])):void 0},d=function(a){b.dragEl&&(a.preventDefault(),b.dragStop(k?a.touches[0]:a)),e=!1},k?(this.element[0].addEventListener(i,l,!1),window.addEventListener(h,j,!1),window.addEventListener(g,d,!1),window.addEventListener(f,d,!1)):(this.on(i,l),c.on(h,j),c.on(g,d))},serialize:function(){var b,c,d,e;return b=void 0,c=0,d=this,e=function(b,c){var f,g;return f=[],g=b.children(d.options.itemNodeName),g.each(function(){var b,g,h,i,j;for(i=a.$(this),h={},b=void 0,j=i.children(d.options.listNodeName),g=0;g<i[0].attributes.length;)b=i[0].attributes[g],0===b.name.indexOf("data-")&&(h[b.name.substr(5)]=a.utils.str2json(b.value)),g++;return j.length&&(h.children=e(j,c+1)),f.push(h)}),f},b=e(d.element,c)},list:function(b){var c,d,e,f;return c=[],e=this,d=0,f=function(d,e,g){var h;return h=d.children(b.itemNodeName),h.each(function(d){var h,i,j;return i=a.$(this),h=a.$.extend({parent_id:g?g:null,depth:e,order:d},i.data()),j=i.children(b.listNodeName),c.push(h),j.length?f(j,e+1,i.data(b.idProperty||"id")):void 0})},b=a.$.extend({},e.options,b),f(e.element,d),c},reset:function(){var a;for(this.mouse={offsetX:0,offsetY:0,startX:0,startY:0,lastX:0,lastY:0,nowX:0,nowY:0,distX:0,distY:0,dirAx:0,dirX:0,dirY:0,lastDirX:0,lastDirY:0,distAxX:0,distAxY:0},this.moving=!1,this.dragEl=null,this.dragRootEl=null,this.dragDepth=0,this.hasNewRoot=!1,this.pointEl=null,a=0;a<m.length;)this.checkEmptyList(m[a]),a++;m=[]},toggleItem:function(a){return this[a.hasClass(this.options.collapsedClass)?"expandItem":"collapseItem"](a)},expandItem:function(a){return a.removeClass(this.options.collapsedClass)},collapseItem:function(a){var b;return b=a.children(this.options.listNodeName),b.length?a.addClass(this.options.collapsedClass):void 0},expandAll:function(){var b;return b=this,this.find(b.options.itemNodeName).each(function(){return b.expandItem(a.$(this))})},collapseAll:function(){var b;return b=this,this.find(b.options.itemNodeName).each(function(){return b.collapseItem(a.$(this))})},setParent:function(a){return a.children(this.options.listNodeName).length?a.addClass("parent"):void 0},unsetParent:function(a){return a.removeClass("parent "+this.options.collapsedClass),a.children(this.options.listNodeName).remove()},dragStart:function(b){var c,d,f,g,h,i,j;for(h=this.mouse,j=a.$(b.target),d=j.closest(this.options.itemNodeName),i=d.offset(),this.placeEl.css("height",d.height()),h.offsetX=b.pageX-i.left,h.offsetY=b.pageY-i.top,h.startX=h.lastX=i.left,h.startY=h.lastY=i.top,this.dragRootEl=this.element,this.dragEl=a.$(document.createElement(this.options.listNodeName)).addClass(this.options.listClass+" "+this.options.dragClass),this.dragEl.css("width",d.width()),e=this.dragEl,this.tmpDragOnSiblings=[d[0].previousSibling,d[0].nextSibling],d.after(this.placeEl),d[0].parentNode.removeChild(d[0]),d.appendTo(this.dragEl),a.$body.append(this.dragEl),this.dragEl.css({left:i.left,top:i.top}),f=void 0,c=void 0,g=this.dragEl.find(this.options.itemNodeName),f=0;f<g.length;)c=a.$(g[f]).parents(this.options.listNodeName).length,c>this.dragDepth&&(this.dragDepth=c),f++;return l.addClass(this.options.movingClass)},dragStop:function(a){var b,c;return b=this.dragEl.children(this.options.itemNodeName).first(),c=this.placeEl.parents("."+this.options.listBaseClass+":first"),b[0].parentNode.removeChild(b[0]),this.placeEl.replaceWith(b),this.dragEl.remove(),this.element[0]!==c[0]?(c.trigger("change.uk.nestable",[b,"added",c,c.data("nestable")]),this.element.trigger("change.uk.nestable",[b,"removed",this.element,this])):this.element.trigger("change.uk.nestable",[b,"moved",this.element,this]),this.trigger("stop.uk.nestable",[this,b]),this.reset(),l.removeClass(this.options.movingClass)},dragMove:function(b){var c,d,e,f,g,h,i,k,l,n,o,p,q,r;if(g=void 0,o=void 0,q=void 0,l=void 0,d=void 0,n=this.options,h=this.mouse,this.dragEl.css({left:b.pageX-h.offsetX,top:b.pageY-h.offsetY}),h.lastX=h.nowX,h.lastY=h.nowY,h.nowX=b.pageX,h.nowY=b.pageY,h.distX=h.nowX-h.lastX,h.distY=h.nowY-h.lastY,h.lastDirX=h.dirX,h.lastDirY=h.dirY,h.dirX=0===h.distX?0:h.distX>0?1:-1,h.dirY=0===h.distY?0:h.distY>0?1:-1,k=Math.abs(h.distX)>Math.abs(h.distY)?1:0,!h.moving)return h.dirAx=k,void(h.moving=!0);if(h.dirAx!==k?(h.distAxX=0,h.distAxY=0):(h.distAxX+=Math.abs(h.distX),0!==h.dirX&&h.dirX!==h.lastDirX&&(h.distAxX=0),h.distAxY+=Math.abs(h.distY),0!==h.dirY&&h.dirY!==h.lastDirY&&(h.distAxY=0)),h.dirAx=k,h.dirAx&&h.distAxX>=n.threshold&&(h.distAxX=0,q=this.placeEl.prev(n.itemNodeName),h.distX>0&&q.length&&!q.hasClass(n.collapsedClass)&&(g=q.find(n.listNodeName).last(),d=this.placeEl.parents(n.listNodeName).length,d+this.dragDepth<=n.maxDepth&&(g.length?(g=q.children(n.listNodeName).last(),g.append(this.placeEl)):(g=a.$("<"+n.listNodeName+"/>").addClass(n.listClass),g.append(this.placeEl),q.append(g),this.setParent(q)))),h.distX<0&&(l=this.placeEl.next(n.itemNodeName),l.length||(o=this.placeEl.parent(),this.placeEl.closest(n.itemNodeName).after(this.placeEl),o.children().length||this.unsetParent(o.parent())))),e=!1,j||(this.dragEl[0].style.visibility="hidden"),this.pointEl=a.$(document.elementFromPoint(b.pageX-document.body.scrollLeft,b.pageY-(window.pageYOffset||document.documentElement.scrollTop))),j||(this.dragEl[0].style.visibility="visible"),this.pointEl.hasClass(n.handleClass)?this.pointEl=this.pointEl.closest(n.itemNodeName):(i=this.pointEl.closest("."+n.itemClass),i.length&&(this.pointEl=i.closest(n.itemNodeName))),this.pointEl.hasClass(n.emptyClass))e=!0;else if(this.pointEl.data("nestable")&&!this.pointEl.children().length)e=!0,this.pointEl=a.$(this.tplempty).appendTo(this.pointEl);else if(!this.pointEl.length||!this.pointEl.hasClass(n.listitemClass))return;if(p=this.element,r=this.pointEl.closest("."+this.options.listBaseClass),f=p[0]!==this.pointEl.closest("."+this.options.listBaseClass)[0],!h.dirAx||f||e){if(f&&n.group!==r.data("nestable-group"))return;if(m.push(p),d=this.dragDepth-1+this.pointEl.parents(n.listNodeName).length,d>n.maxDepth)return;c=b.pageY<this.pointEl.offset().top+this.pointEl.height()/2,o=this.placeEl.parent(),e?this.pointEl.replaceWith(this.placeEl):c?this.pointEl.before(this.placeEl):this.pointEl.after(this.placeEl),o.children().length||o.data("clique.data.nestable")||this.unsetParent(o.parent()),this.checkEmptyList(this.dragRootEl),this.checkEmptyList(p),f&&(this.dragRootEl=r,this.hasNewRoot=this.element[0]!==this.dragRootEl[0])}},checkEmptyList:function(b){return b=b?a.$(b):this.element,b.children().length?void 0:b.find("."+this.options.emptyClass).remove().end().append(this.tplempty)}}),a.nestable});